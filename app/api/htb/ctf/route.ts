/**
 * HTB CTF API Route
 * Serves solved machines data from the JSON file generated by fetchSolvedMachines.js
 * The JSON file is updated daily via cron job
 */

import { NextResponse } from "next/server";
import { readFileSync, existsSync } from "fs";
import { join } from "path";
import type { MachinesResponse, MachineSolved } from "@/lib/types/htb";

const JSON_FILE_PATH = join(process.cwd(), "public", "htb", "solved-machines.json");

/**
 * Transform the JSON format to the frontend format
 */
function transformMachines(machines: Array<{
  id: number;
  name: string;
  os: string;
  difficulty: string;
  solveDate?: string | null;
  htbUrl: string;
  skills?: string[];
  tags?: string[];
  attackPaths?: string[];
  difficultyRatings?: any;
}>): MachineSolved[] {
  return machines.map((machine) => ({
    id: machine.id,
    name: machine.name,
    url: machine.htbUrl,
    type: "Machine" as const,
    difficulty: machine.difficulty as MachineSolved["difficulty"],
    difficultyNumeric: getDifficultyNumeric(machine.difficulty),
    os: machine.os as MachineSolved["os"],
    solveDate: machine.solveDate || new Date().toISOString(),
    status: "Active" as const, // Default status
    isActive: true,
    isRetired: false,
    points: 0,
    tags: machine.tags || [],
    skills: machine.skills || [],
    attackPaths: machine.attackPaths || [],
    difficultyRatings: machine.difficultyRatings || null,
    writeupUrl: machine.writeupUrl || null,
    hasWriteup: machine.hasWriteup || false,
  }));
}

/**
 * Get numeric difficulty value for sorting
 */
function getDifficultyNumeric(difficulty: string): number {
  const map: Record<string, number> = {
    Tutorial: 0,
    Easy: 20,
    Medium: 50,
    Hard: 80,
    Insane: 100,
  };
  return map[difficulty] || 20;
}

/**
 * Calculate statistics from machines
 */
function calculateStats(machines: MachineSolved[]) {
  const stats = {
    total: machines.length,
    byDifficulty: {} as Record<string, number>,
    byOS: {} as Record<string, number>,
    byStatus: {} as Record<string, number>,
    byYear: {} as Record<string, number>,
    uniqueTags: [] as string[],
    uniqueSkills: [] as string[],
  };

  const allTags = new Set<string>();
  const allSkills = new Set<string>();

  machines.forEach((machine) => {
    // Count by difficulty
    stats.byDifficulty[machine.difficulty] = (stats.byDifficulty[machine.difficulty] || 0) + 1;
    
    // Count by OS
    stats.byOS[machine.os] = (stats.byOS[machine.os] || 0) + 1;
    
    // Count by status
    stats.byStatus[machine.status] = (stats.byStatus[machine.status] || 0) + 1;
    
    // Count by year
    if (machine.solveDate) {
      const year = new Date(machine.solveDate).getFullYear().toString();
      stats.byYear[year] = (stats.byYear[year] || 0) + 1;
    }
    
    // Collect tags
    if (machine.tags && Array.isArray(machine.tags)) {
      machine.tags.forEach((tag) => {
        if (tag) allTags.add(tag);
      });
    }
    
    // Collect skills
    if (machine.skills && Array.isArray(machine.skills)) {
      machine.skills.forEach((skill) => {
        if (skill) allSkills.add(skill);
      });
    }
  });

  stats.uniqueTags = Array.from(allTags).sort();
  stats.uniqueSkills = Array.from(allSkills).sort();

  return stats;
}

export async function GET() {
  try {
    // Check if JSON file exists
    if (!existsSync(JSON_FILE_PATH)) {
      console.warn(`[HTB API] JSON file not found at ${JSON_FILE_PATH}`);
      console.warn("[HTB API] Please run scripts/fetchSolvedMachines.js to generate the data file");
      
      return NextResponse.json(
        {
          machines: [],
          total: 0,
          stats: {
            total: 0,
            byDifficulty: {},
            byOS: {},
            byStatus: {},
            byYear: {},
            uniqueTags: [],
            uniqueSkills: [],
          },
        },
        { status: 200 }
      );
    }

    // Read and parse JSON file
    const fileContent = readFileSync(JSON_FILE_PATH, "utf8");
    const jsonData = JSON.parse(fileContent);

    // Validate structure
    if (!jsonData.machines || !Array.isArray(jsonData.machines)) {
      throw new Error("Invalid JSON structure: machines array not found");
    }

    // Transform to frontend format
    const machines = transformMachines(jsonData.machines);

    // Calculate statistics
    const stats = calculateStats(machines);

    // Prepare response
    const response: MachinesResponse = {
      machines,
      total: machines.length,
      stats,
    };

    console.log(`[HTB API] Serving ${machines.length} machines from JSON file (last updated: ${jsonData.lastUpdated || "unknown"})`);

    return NextResponse.json(response);
  } catch (error) {
    console.error("[HTB API] Error reading HTB CTF data:", error);
    
    const errorMessage = error instanceof Error ? error.message : "Unknown error";
    
    return NextResponse.json(
      {
        error: "Failed to read HTB data",
        message: errorMessage,
        machines: [],
        total: 0,
        stats: {
          total: 0,
          byDifficulty: {},
          byOS: {},
          byStatus: {},
          byYear: {},
          uniqueTags: [],
          uniqueSkills: [],
        },
      },
      { status: 500 }
    );
  }
}
